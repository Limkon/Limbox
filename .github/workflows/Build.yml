name: Windows Manual Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false
        cache: false
        install: git

    - name: Fix Signatures and Install Dependencies
      shell: msys2 {0}
      run: |
        echo "Applying ultimate fix for GPG signature errors..."
        
        # 1. 临时禁用签名检查 (修改 /etc/pacman.conf)
        # 这允许我们在没有有效密钥的情况下下载新的密钥环
        sed -i 's/^SigLevel.*/SigLevel = Never/' /etc/pacman.conf
        
        # 2. 强行更新密钥环 (msys2-keyring)
        echo "Updating keyring without signature check..."
        pacman -Sy --noconfirm msys2-keyring
        
        # 3. 恢复签名检查 (为了安全)
        sed -i 's/^SigLevel.*/SigLevel = Required DatabaseOptional/' /etc/pacman.conf
        
        # 4. 重新初始化密钥 (确保新下载的密钥生效)
        echo "Re-initializing GPG keys..."
        rm -rf /etc/pacman.d/gnupg
        pacman-key --init
        pacman-key --populate msys2
        
        # 5. 再次同步数据库 (确保现在签名验证通过)
        pacman -Sy
        
        # 6. 安装编译工具
        echo "Installing build tools..."
        pacman -S --noconfirm mingw-w64-x86_64-gcc mingw-w64-x86_64-openssl mingw-w64-x86_64-make

    - name: Compile Resources
      shell: msys2 {0}
      run: |
        windres -i resource.rc -o resource.res --target=pe-x86-64 -O coff

    - name: Compile Executable
      shell: msys2 {0}
      run: |
        gcc main.c resource.res -o limbox.exe \
          -lssl -lcrypto -lws2_32 -lgdi32 -lcomctl32 -lwininet -lcrypt32 -luser32 \
          -mwindows -municode -finput-charset=UTF-8 -static

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: limbox-executable
        path: limbox.exe
